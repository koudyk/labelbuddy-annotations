{"text": "Van, Andrew N. and Montez, David F. and Laumann, Timothy O. and Suljic, Vahdeta and Madison, Thomas and Baden, Noah J. and Ramirez-Perez, Nadeshka and Scheidter, Kristen M. and Monk, Julia S. and Whiting, Forrest I. and Adeyemo, Babatunde and Chauvin, Roselyne J. and Krimmel, Samuel R. and Metoki, Athanasia and Rajesh, Aishwarya and Roland, Jarod L. and Salo, Taylor and Wang, Anxu and Weldon, Kimberly B. and Sotiras, Aristeidis and Shimony, Joshua S. and Kay, Benjamin P. and Nelson, Steven M. and Tervo-Clemmens, Brenden and Marek, Scott A. and Vizioli, Luca and Yacoub, Essa and Satterthwaite, Theodore D. and Gordon, Evan M. and Fair, Damien A. and Tisdall, M. Dylan and Dosenbach, Nico U.F.\nbioRxiv, 2023\n\n# Title\n\nFramewise multi-echo distortion correction for superior functional MRI\n\n# Keywords\n\nDistortion Correction\nfMRI\nMulti-Echo\n\n\n# Abstract\n \nFunctional MRI (fMRI) data are severely distorted by magnetic field (B0) inhomogeneities which currently must be corrected using separately acquired field map data. However, changes in the head position of a scanning participant across fMRI frames can cause changes in the B0 field, preventing accurate correction of geometric distortions. Additionally, field maps can be corrupted by movement during their acquisition, preventing distortion correction altogether. In this study, we use phase information from multi-echo (ME) fMRI data to dynamically sample distortion due to fluctuating B0 field inhomogeneity across frames by acquiring multiple echoes during a single EPI readout. Our distortion correction approach, MEDIC (Multi-Echo DIstortion Correction), accurately estimates B0 related distortions for each frame of multi-echo fMRI data. Here, we demonstrate that MEDIC\u2019s framewise distortion correction produces improved alignment to anatomy and decreases the impact of head motion on resting-state functional connectivity (RSFC) maps, in higher motion data, when compared to the prior gold standard approach (i.e., TOPUP). Enhanced framewise distortion correction with MEDIC, without the requirement for field map collection, furthers the advantage of multi-echo over single-echo fMRI. \n \n\n# Body\n \n## Introduction \n  \nFunctional MRI (fMRI) data acquired using echo planar imaging (EPI) sequences are prone to local image distortions due to magnetic field inhomogeneities (B0) arising from differences in magnetic susceptibility, particularly across air-tissue interfaces [ ]. The orbitofrontal and inferior temporal cortices suffer the largest distortion due to their proximity to the sinuses, mastoids, and ear canals [ ], but distortion is present to varying degrees across the brain. The presence of local image distortion is particularly problematic for functional connectivity (FC) and task fMRI analyses, which rely on accurate co-registration of functional and anatomical data. Image distortion degrades the performance of registration algorithms used to align functional data to anatomical data and prevents accurate spatial localization of anatomical features in fMRI studies [ ,  ]. \n\nTo correct geometric distortions in fMRI data, dedicated field map scans are acquired before fMRI acquisitions to estimate the B0 field inhomogeneity [ ,  ]. However, such static distortion correction approaches are vulnerable to head motion [ ] and represent only a snapshot of the field inhomogeneities. Head movement during fMRI is notorious for introducing significant noise and systematic artifacts into the data [ ]. In the context of susceptibility artifact correction, head position and motion will compromise the accuracy of the field map data, rendering distortion corrections inaccurate. Distortion corrections estimated from separately-collected field maps are accurate only so long as the participant\u2019s head remains in the same position they were in when the field map was collected. This is because rotations about axes orthogonal to the main magnetic field (i.e., through-plane rotations, when slices are defined axially) change the susceptibility induced inhomogeneities in the B0 magnetic field [ ] and thus the degree of distortion in the fMRI data. Thus, a distortion correction method that is robust to head motion and position would greatly benefit fMRI, particularly where motion may be related to phenomena of interest [ ]. \n\nMulti-echo fMRI (ME-fMRI) has been shown to have several advantages for BOLD signal detection relative to single-echo sequences [ ]. By combining data across echoes, ME-fMRI increases BOLD signal sensitivity, particularly to regions that have significant signal dropout at typical single-echo times [ ]. Further, multiple echo times allows modeling and separation of neurobiologically relevant fMRI signals from physiological and physics-related artifacts [ ,  ]. These features of ME-fMRI have been shown to improve reliability of RSFC estimation, especially in clinically relevant subcortical brain regions like the subgenual cingulate, basal ganglia, and cerebellum [ ]. The improved reliability is attributed to greater signal-to-noise ratio (SNR), enabling more rapid and precise mapping of the brain. \n\nfMRI data are complex signals composed of magnitude and phase components, where magnitude images at each TR are typically used to evaluate temporal changes in BOLD contrast via T2 . However, ME-fMRI phase data from each TR provides spatial and temporal information about magnetic field variations. By measuring the difference in phase between echoes in ME-fMRI data, the B0 field inhomogeneity can be estimated as the slope of the linear relationship between phase and echo time [ ]. Since phase information can be acquired at every TR, a frame-by-frame measure of the B0 field inhomogeneity can be estimated, allowing for more accurate, motion-robust, framewise correction of susceptibility distortion in ME-fMRI data. Frame-wise distortion correction in ME-fMRI also eliminates the need for separate field map acquisitions, which are required for static distortion correction \n\nCapitalizing on the recent surge in ME-fMRI usage, we built an easy-to-use, precise method for dynamic, frame-wise distortion correction. Here we describe our open-source, high-speed Multi-Echo DIstortion Correction (MEDIC) algorithm for correcting susceptibility distortions in fMRI data. Comparisons of MEDIC against a current gold standard method, which uses a single static B0 estimation and correction (TOPUP) [ ], demonstrate its superiority, especially in the presence of head motion. \n\n\n## Results \n  \n### MEDIC captures magnetic field changes due to head motion \n  \nChanges in the B0 magnetic field due to head motion are primarily attributable to the shifting position of susceptibility sources relative to the main magnetic field. Unlike traditional static field map methods, MEDIC field maps capture these dynamic alterations in a framewise manner. To demonstrate the efficacy of MEDIC in capturing magnetic field changes due to motion, we collected data while a participant rotated their head about each of the cardinal axes, in addition to acquiring data in a neutral head position. Dynamic field maps were then extracted from the phase information of the resulting scans using MEDIC. The difference between field maps acquired in the neutral and rotated head positions was subsequently calculated (Neutral - Rotation). Average and standard deviation motion parameters for each head position are documented in  . \n\nAs the participant rotated their head relative to the neutral resting head position, we observed changes in the B0 field estimated from the framewise field maps (  and  \u2013 ). To measure the change in B0 inhomogeneity due to head motion, the field maps for each head rotation were rigid-body realigned to the neutral head position and the difference was computed (Neutral - Rotation). Exemplar frames of the acquired data show the participant rotating their head along each of the cardinal axes in the scanner throughout the time series ( ). We found that rotations about the slice direction (Z-axis) led to small changes in the field map ( ). In contrast, rotations about the readout (X-axis) and phase encoding (Y-axis) directions caused significant changes in the field map ( ), suggesting that MEDIC-derived field maps are sensitive to changes in the B0 field due to motion. For the particular ME-fMRI sequence used, for every change of 10 Hz in the B0 field, each voxel is displaced by ~0.6 mm. For rotations about the slice direction, we observed similar, but small, spatial patterns in the field map difference as in rotations about the phase encoding direction. We largely attribute these similarities to the small Y-axis rotations present in the Z-axis rotation data ( ). \n\n\n### MEDIC dynamic distortion correction reduces the impact of head motion on functional connectivity estimates \n  \nTo assess the effects of these changes on resting-state functional connectivity (RSFC) analyses, as well as the ability for MEDIC to mitigate these B0 field change effects, we compared the functional connectivity maps of data derived from this head motion study to a low motion dataset from the same participant. These data were preprocessed (see  ) and distortion corrected separately using both MEDIC and FSL TOPUP, the current gold standard in distortion correction. A separately acquired field map scan in the neutral head position (Frame 50,  ) was used for TOPUP distortion correction, reflecting a typical data acquisition experiment of a single field map acquisition at the beginning of a functional scan (See  ). Both MEDIC and TOPUP preprocessed data were projected to the surface. Functional connectivity maps were computed from seeds in the dorso-lateral prefrontal cortex (DLPFC), the extrastriate visual cortex, and the somato-cognitive action network (SCAN) region of primary motor cortex [ ]. To assess the effectiveness of distortion correction, the quality of these maps were evaluated by comparing them to a large, low-motion dataset from the same participant, processed with TOPUP. \n\nThe exemplar seed maps show that high motion MEDIC corrected data were more similar to the low motion data than TOPUP corrected high motion data, despite the low motion (gold standard) data being processed with TOPUP ( ). Greater improvement in similarity to the low motion data was observed in DLPFC and occipital cortex ( , ) compared to SCAN ( ). We observed that the mean correlation between high-motion MEDIC-corrected seed maps and low-motion seed maps was R = 0.35 (SD: 0.16). In contrast, the mean correlation between high-motion TOPUP-corrected seed maps and low-motion data was R = 0.32 (SD: 0.15). Using a two-tailed paired t-test, we found this difference to be statistically significant (two-tailed paired t = 64.13; p < 0.001; df = 59411), indicating that MEDIC corrected data is more similar to low motion corrected data and has greater robustness to head motion. \n\n\n### MEDIC dynamic distortion correction improves functional connectivity in pediatric populations \n  \nUncorrected geometric distortion introduces participant-to-participant variability in RSFC structure. We reasoned that improved distortion correction would produce individual RSFC estimates that align more closely with a group average. To accomplish this, we compared MEDIC and TOPUP distortion-corrected FC maps to gold-standard group-averaged data, processed with TOPUP (ABCD Study; N = 3,928) [ ]. We used our Adolescent dataset containing repeated-sampling precision ME-fMRI data from 21 participants (9\u201312 years old, 8M, 13F), with a total of 185 runs. These ME-fMRI data were preprocessed with both MEDIC and TOPUP for resting-state functional connectivity analyses. \n\nSeeds maps from both MEDIC and TOPUP processed data were compared to the ABCD group-averaged data ( ; left). In the occipital cortex, the TOPUP corrected data showed correlations not observed in the ABCD group ( , right: seed correlation to group-averaged data r = 0.04) that were removed by reprocessing the identical data with MEDIC ( , middle: seed correlation to group-averaged data r = 0.44) (Squared Error: MEDIC = 0.03 (SD: 0.07), TOPUP = 0.07 (SD: 0.10); two-tailed paired t = \u221284.6; p < 0.001; df = 59411). \n\nTo quantify the benefits of dynamic distortion correction with MEDIC across the entire Adolescent dataset, cortical seed maps at every vertex for each scan were compared to the corresponding group-averaged standard map (ABCD) through spatial correlations. These spatial correlations were then averaged across all vertices ( ; y-axis). The same assessment was done with TOPUP ( ; x-axis). MEDIC corrected data were overall more similar to the ABCD group average compared to TOPUP corrected data (MEDIC: 147; TOPUP: 38; two-tailed paired t = 9.37; p < 0.001; df = 184). \n\nFinally, we sought to understand the regions in which MEDIC improved distortion correction. We examined the spatial pattern of distortion correction differences by doing a vertex-wise paired t-test to generate a vertex-wise t-statistic whole-brain map showing those regions where MEDIC was more similar to the group-averaged data ( ; hot colors). A clustering based multiple comparisons correction was applied to correct to a significance level of 0.05 (uncorrected p-value 0.01) and leaving only statistically significant clusters. This whole-brain map of similarity to the group average revealed that the benefits of using MEDIC dynamic distortion correction were greatest in the medial prefrontal and occipital cortex ( ). \n\n\n### MEDIC frame-wise distortion correction produces superior anatomical alignment \n  \nOne goal of distortion correction is to improve co-registration of the fMRI to the anatomical data. Therefore, we assessed alignment accuracy by using the gray and white matter surfaces generated from anatomical segmentations [ ]. When distortion correction is optimal, the gray and white matter surfaces obtained from anatomical data should also delineate the gray and white matter voxels in functional data on both the cortical and cerebellar surfaces. For this assessment, data from three separate SIEMENS Prisma MRI scanners at three different institutions: Washington University in St. Louis (WashU, selected participant from the Adolescent dataset), University of Minnesota (UMinn), and University of Pennsylvania (Penn) were processed and distortion corrected using MEDIC and TOPUP. We used participants from three different scanning sites to eliminate scanner-specific effects in the comparison between MEDIC and TOPUP anatomical alignment. Gray and white matter surfaces produced by anatomical segmentations from Freesurfer 7.3.2 [ ] were overlaid on the averaged, atlas-aligned, distortion corrected functional volumes. \n\nField map differences between MEDIC and TOPUP were found to occur along the slice-encoding direction for all participants ( ). In regions with large MEDIC-TOPUP distortion differences ( ; top row), we hypothesized that we would also exhibit observable differences in registration to anatomy. This appeared to be the case; and further, in all of these regions, the MEDIC image was better aligned to the anatomy than the TOPUP image. \n\nIn the WashU dataset ( ), the most prominent difference was observed in the cerebellum. In the TOPUP corrected data the inferior cerebellum was shifted approximately 3 mm anteriorly compared to the anatomical segmentation reference. MEDIC corrected data closely aligned with the cerebellar anatomy, suggesting a higher efficacy for cerebellar alignment. For the UMinn dataset ( ), we identified discrepancies in the dorsal cerebral cortex. The sulci in the TOPUP corrected images were shifted 2\u20133 mm anteriorly relative to the anatomical reference. In contrast, the MEDIC corrected data showed a good agreement with the cortical anatomy. Finally, in the Penn dataset ( ), a distortion profile similar to that of the UMinn data was observed. Specifically, the greatest differences appeared in the dorsal cortical region. The TOPUP corrected data displayed a 1\u20132 mm anterior shift in cortical structures relative to the anatomical reference. Meanwhile, the MEDIC corrected data maintained good alignment with the cortical anatomy. \n\n\n### MEDIC distortion correction is superior on local and global anatomical alignment metrics \n  \nTo quantify anatomical alignment performance for MEDIC and TOPUP, we computed established local and global alignment metrics [ ] between distortion corrected functional data and their corresponding T1w and T2w anatomical data (full statistical tables for each alignment metric are given in  ). We computed all alignment metrics for the Adolescent dataset across 185 scans from 21 participants in both MEDIC and TOPUP corrected data. \n\nTo assess local image correspondence, we computed the squared correlation (  R  ) within a \u201cspotlight\u201d, a 3 voxel radius sphere window, between each of T1w and T2w anatomical and the reference functional image. Two tailed paired t-tests were computed for each voxel across all functional data scans in the Adolescent dataset (N = 185) to determine which distortion correction strategy was more similar to the anatomy at a local spotlight. Clustering based multiple comparisons correction was applied to correct to a significance level of 0.05 (uncorrected p-value 0.01). Higher t-statistic values indicated MEDIC was more similar to the anatomical image than TOPUP ( ). MEDIC distortion corrected data had higher local similarity to the anatomical data than TOPUP distortion corrected data in gray matter. Areas where TOPUP performed better were restricted to areas of white matter and CSF, particularly in white matter areas adjacent to the lateral ventricle. \n\nFurther quantifying the local similarity, we computed the mean of   R   values across all spotlights for each scan ( ). MEDIC significantly outperformed static TOPUP correction in both the T1w   R   spotlight (MEDIC = 0.068 (SD: 0.007); TOPUP = 0.066 (SD: 0.008); two-tailed paired t = 7.133; p < 0.001; df = 184) and T2w   R   spotlight (MEDIC = 0.083 (SD: 0.010); TOPUP = 0.081 (SD: 0.011); two-tailed paired t = 6.124; p < 0.001; df = 184) analyses. \n\nTo assess global image correspondence, we used multiple global metrics such as the squared correlation (  R  ), correlation of the gradient magnitude, and normalized mutual information (NMI) between each distortion corrected functional image and each T1w and T2w anatomical image ( ) [ ]. MEDIC significantly outperformed TOPUP on both T1w   R   (MEDIC = 0.063 (SD: 0.028); TOPUP = 0.060 (SD: 0.028); two-tailed paired t = 11.284; p < 0.001; df = 184) and T2w   R   (MEDIC = 0.457 (SD: 0.053); TOPUP = 0.454 (SD: 0.056); two-tailed paired t = 2.729; p = 0.007; df = 184) metrics, as well as the T1w gradient correlation (MEDIC = 0.43 (SD: 0.028); TOPUP = 0.414 (SD: 0.036); two-tailed paired t = 11.727; p < 0.001; df = 184) metric. TOPUP slightly outperformed MEDIC on the T2w NMI (MEDIC = 0.836 (SD: 0.026); TOPUP = 0.838 (SD: 0.026); two-tailed paired t = \u22121.985; p = 0.049; df = 184) metric. \n\nFinally, we examined alignment along specific tissue boundaries, delineated by the participant\u2019s anatomical segmentation [ ]. By overlaying the participant\u2019s anatomical segmentation on the time-average fMRI data, and computing the Receiver Operating Characteristic (ROC) curve, we determined how well each distortion correction method correctly delineated tissue types along specific boundaries by computing the area under the curve (AUC) value ( ). MEDIC significantly outperformed TOPUP correction in both the brain/exterior (MEDIC = 0.735 (SD: 0.035); TOPUP = 0.729 (SD: 0.034); two-tailed paired t=11.488; p < 0.001; df = 184) the gray/white matter (MEDIC = 0.735 (SD: 0.035); TOPUP = 0.729 (SD: 0.034); two-tailed paired t=11.488; p < 0.001; df = 184), and cerebellum/exterior (MEDIC = 0.607 (SD: 0.041); TOPUP = 0.596 (SD: 0.049); two-tailed paired t=5.073; p < 0.001; df = 184) boundaries. \n\n\n\n## Discussion \n  \nIn fMRI studies, distortion of the source images is transmitted downstream, distorting all derived research findings and clinical maps [ ]. Previously state-of-the-art methods employed static distortion correction techniques that depend on the acquisition of a separate field map image [ ,  ]. However, static field mapping is limiting and becomes less accurate with larger head displacements during a scan [ ,  ]. Given the massive challenge of head motion, especially in children, the elderly, and patient populations [ ,  \u2013 ], motion robust distortion correction is crucial for the success of fMRI studies in these subpopulations. \n\nDespite the conceptual superiority of dynamic field mapping approaches, prior attempts have not been widely adopted by the neuroimaging community [ ,  ]. This is largely due to the lack of availability of multi-echo sequences, difficulty in implementation, and widely available open-source releases of said approaches. With the recent growing interest and use of ME-fMRI for neuroimaging studies, our proposed method, MEDIC, provides researchers the capability to address dynamic B0 changes due to head motion. MEDIC is provided as a freely available open source tool, and will further motivate the use of ME-fMRI in neuroimaging studies. \n\n### ME-fMRI enhances sensitivity, reliability, and signal coverage in neuroimaging \n  \nME-fMRI has many benefits over single-echo fMRI (SE-fMRI) and has been established for at least a decade [ ,  ,  ]. ME-fMRI allows for multiple echoes to be analyzed separately or as an optimally combined time series, which exhibits higher SNR and improves statistical power of analyses in regions of high susceptibility. Multiple echoes also allow for additional denoising capabilities through ME-ICA [ ,  ] or denoising pipelines, such as tedana [ ]. \n\nRecent neuroimaging breakthroughs, such as the discovery of the somato-cognitive action network (SCAN), in the central sulcus, which was previously thought to be the exclusive domain of effector-specific primary motor cortex [ ], utilized ME-fMRI data. ME-fMRI was also used to discover that the ventromedial prefrontal cortex (vmPFC), a region plagued by massive distortions, includes an enlarged salience network node in depression patients [ ]. Similarly, ME-fMRI was able to identify individual-specific persistent brain changes after a single dose of the psychedelic psilocybin [ ]. \n\nPatient- (clinical) and individual-specific (research) precision functional mapping (PFM) [ ] are specific applications of RSFC and task fMRI where ME-fMRI and by extension MEDIC are most valuable. Averaging fMRI data across individuals blurs spatial boundaries, effectively smoothing the underlying data [ ,  \u2013 ]. Therefore, group-averaging partially obscures the greater spatial precision obtainable with ME-fMRI and MEDIC. Hence, it may not be a coincidence that several strong proponents of ME-fMRI have been using it for PFM, through which greater confidence in spatial details can be directly converted into neuroscientific insights [ ,  ,  ,  ,  ]. If the goal is individual-specific PFM, then ME-fMRI and MEDIC improve SNR and distortion correction, with the minor cost of slightly longer data processing times and increase in TR. Furthermore, with MEDIC, field map scans can be eliminated from the scanning protocol, eliminating the risk that some field maps end up motion corrupted or lost altogether. \n\n\n### MEDIC further boosts the capabilities of ME-fMRI through dynamic field map correction \n  \nHead motion also impacts distortions by changing the spatial distribution of the B0 field inhomogeneity [ ,  ]. Changes to the B0 magnetic field result when someone rotates their head out of the slice plane (i.e. readout and phase encoding directions). Traditional static field maps cannot account for these time-varying changes to the field, since they only measure the B0 field at a single time point before or after a scan. In addition, any head motion that occurs between the field map acquisition and the fMRI scan will also reduce the accuracy of distortion correction due to localization errors. \n\nComputing the phase evolution across multiple echo times across a ME-fMRI sequence allows one to compute a field map for each data frame, allowing for the tracking of magnetic field (B0) inhomogeneities dynamically and as close to real-time as possible. With MEDIC, this results in two main benefits. First, this allows MEDIC to measure the B0 field at each TR, allowing for the measurement of any time-varying changes to the field. Second, since MEDIC field maps are inherently co-registered to the ME-fMRI data it is correcting, and eliminating any errors in co-registration that may arise from separate field map acquisitions. \n\nAs a general observation, for every 1 degree of head rotation outside of the slice plane, we estimated a maximum change in the B0 field of 5 Hz/0.3 mm in our data, representing the maximum error in distortion correction one would obtain by using a static field map. Therefore, any functional connectivity analysis done in the presence of notable head motion would benefit from MEDIC dynamic distortion corrections. In living participants, motion can never be fully eliminated, even when using external devices such as head restraints to mitigate head motion [ ] or sedation, which often is prohibitive in studies. Infants, children, the elderly and patient populations typically have the highest head motion [ ,  \u2013 ] and utilization of ME-fMRI and MEDIC will likely be most beneficial in these groups. \n\n\n### MEDIC provides superior distortion correction due to self-reference \n  \nMEDIC field maps generated correction results more similar to group-averaged data than those produced by the TOPUP method. Importantly, this occurred even though the group-averaged data had been distortion-corrected using TOPUP- a circumstance that one would assume would inherently be biased towards TOPUP\u2019s performance. Notably, we observed greater correspondence between MEDIC and the group-averaged functional connectivity maps within the medial prefrontal cortex and the occipital regions. In addition, there were still large local distortions even after correction with TOPUP, particularly in the dorsal cortical surface and cerebellum. \n\nWe attribute MEDIC\u2019s superior distortion correction capabilities to the fact that MEDIC uses field maps sourced from the same data it is correcting. This \u201cself-reference\u201d property provides two main benefits: first, fluctuations in head motion may have led to differences in the measured field, which static field maps only measure at a single point in time, potentially causing inaccurate localization of B0 field inhomogeneities and, consequently, less than ideal distortion correction. Second, a single time point static field map might not accurately estimate the B0 field inhomogeneity of the scan it is meant to correct, leading to suboptimal distortion correction. This can result from a mismatch in acquisition parameters from the fMRI data and the field map data, leading to differences in affected B0 inhomogeneity. In such cases, MEDIC based distortion correction is able to correct for additional off-resonance effects. \n\n\n### On parameter selection in ME-fMRI and MEDIC \n  \nDespite the benefits of ME-fMRI, one drawback is the requisite increase in TR due to the collection of additional echoes [ ]. For single-echo fMRI acquisitions, echo times are typically around ~30 ms (TE). In multi-echo, any additional echo after this time represents the increase in TR over a single-echo acquisition. For example, for a 3-echo acquisition with echo times of 15 ms, 30 ms, and 45 ms, would require an extra 15 ms per RF pulse compared to a single echo acquisition. This increase in TR can be mitigated if one were to reduce the number of slices, at the cost of a smaller field of view (FOV), or by increasing the parallel imaging acceleration factors, while maintaining the same FOV. Acceleration techniques, including both in-plane undersampling and multi-band (simultaneous multi-slice), are a must if one desires multiple echoes, a TR of ~1 second and resolutions of 2.4 mm or smaller. Most recent ME fMRI sequences seem to utilize 3\u20135 echoes with the second echo around ~30 ms [ ,  \u2013 ]. The acquisition of higher spatial resolution images is additionally challenging with ME fMRI as even more acceleration is required in order to acquire multiple echoes without unacceptably long readout times and/or TRs. \n\nThe addition of MEDIC does not largely change these considerations. In our study, relatively late echo times were used (TE1 = 14.2 ms, TE2 = 38.93 ms), but still found to be effective at measuring phase and correcting distortion. The use of earlier echo times may improve the performance of MEDIC even further, particularly in areas of high susceptibility [ ]. MEDIC only requires the use of two echoes to compute a field map, which is under the typical acquisition of 3\u20135 echoes. However, in cases where users may want to use larger echo spacings, the identifiability of the field map computation may breakdown, preventing accurate field map estimations. In such cases, more echoes may be preferred to obtain a unique solution. \n\n\n### MEDIC is computationally efficient and open-source \n  \nOur open-source implementation of MEDIC is optimized, resulting in computational times comparable to TOPUP for an entire dataset. Overall, the computational time to estimate MEDIC field maps over an entire dataset is generally comparable to the processing time required by TOPUP in its field map estimation process. Computation can be further reduced by running MEDIC\u2019s parallel algorithm on a computer with multiple cores. \n\nWhile previous methods of multi-echo dynamic distortion correction have been suggested [ ,  ], lack of functioning open source implementations of such methods have impeded their adoption. We therefore release our implementation of MEDIC as an open-source package, which can be found at  . This package is a Python library that can be integrated in a variety of processing pipelines and existing neuroimaging tools with output formats into AFNI, FSL, and ANTs [ \u2013 ]. We hope that this will facilitate the adoption of MEDIC in the neuroimaging community. \n\n\n### Multi-echo framewise distortion correction for motion robust fMRI \n  \nMEDIC\u2019s dynamic, frame-wise distortion correction, is not only conceptually superior to static field-map approaches, but significantly improves the accuracy of fMRI maps, especially in the presence of head motion. MEDIC is easy-to-implement and use and despite computing a dynamic field map at each data frame, is no slower than previously standard static distortion correction (i.e., TOPUP). ME-fMRI is recently gaining popularity more rapidly, at least in part due to its benefits for patient- or individual-specific precision functional mapping (PFM) [ ]. MEDIC\u2019s dynamic distortion correction capability provides another driving reason to acquire multi-echo data. For fMRI applications aiming to maximize spatial precision, such as PFM, or intervention and neuromodulation targeting with fMRI, MEDIC provides yet another powerful reason to switch from single- to multi-echo. \n\n\n\n## Methods \n  \n### Multi-Echo DIstortion Correction (MEDIC) \n  \nTo obtain field maps at each frame of a ME-fMRI acquisition, phase at multiple echo times must be measured. The field map is the slope of the relationship between phase and echo time. Therefore, at a minimum, at least two echoes are needed to compute the phase accumulation over time, i.e. the field map. \n\nComputing the field map is complicated by several factors. First, the phase measured at each echo time contains a constant offset, such that the phase at zero echo time is not zero. This is a result of the coil combination process during reconstruction of the phase images, which can result in a phase offset [ ]. The second is the wrapping of the phase measurements, which bounds the domain of the measured phase between [\u2212  \u03c0,\u03c0  ] [ ]. This is a result of the phase being a periodic function and is a common problem when measuring a signal\u2019s phase information. Finally, the measured field map obtained from an ME-fMRI image is in the space of the distorted image, and must be transformed to the undistorted space to be used for distortion correction. \n\n#### The wrapped phase difference problem \n  \nConsider a single frame of ME-fMRI data, where n echoes of phase and magnitude data are acquired at different echo times   t   ,t   ,\u2026,t  . Using the phase difference method [ ,  ], the phase information of the ME-EPI data can be related to the B0 field inhomogeneity by the following:\n \nwhere \u0394  \u03d5   is the phase difference between two echoes,   \u03b3   is the gyromagnetic ratio, \u0394  B   is the B0 field inhomogeneity, and t is the echo time difference. For brevity, we denote the field map as   f  , which is defined as   f   =   \u03b3  \u0394  B  . When images acquired from more than two echoes are available,   generalizes to:\n \nwhere   is the spatial location for a given voxel, and   n   denotes the number of echoes in the data. Solving   for   f   amounts to solving   N   linear systems, where   N   is the number of voxels in the image. \n\nIn practice, solving   is complicated by two additional effects. The first is that phase information acquired from the scanner is wrapped, such that phase values beyond the range of [\u2212  \u03c0,\u03c0  ], are wrapped back into the other side of the interval. Second,   assumes that the phase accumulation at t=0 is zero, a fact which, depending on the specifics of the coil-combine algorithm applied to the phase data, is often not the case. The full model accounting for both of these effects is given by:\n \nwhere \u2126 is a wrapping operator that, such that  , the wrapped phase, and (\u00b7)  is an unwrapping operator, such that   for some integer   k  , and   \u03d5   is the phase accumulation at   t   = 0. Note that the wrapped phase   is what is measured off the scanner. With the addition of phase wrapping and offset effects,   is no longer a simple linear system when trying to solve for   f  . \n\n\n#### Phase offset correction and unwrapping \n  \nEstimation and removal of the phase offset is accomplished using the MCPC-3D-S algorithm [ ]. MCPC-3D-S estimates the phase offset by computing the unwrapped phase difference between the first and second echoes of the data, then estimating the phase offset by assuming linear phase accumulation between the first and second echoes. This is given by the following:\n \n\nIn the case of MCPC-3D-S, the ROMEO unwrapping algorithm is used to unwrap   [ ]. Once   \u03d5   is computed, the effects of the phase offset can be removed from   by subtracting   \u03d5   from the phase at each echo time. \n\nPhase unwrapping is performed using the ROMEO algorithm [ ]. Phase information at later echoes tend to suffer from phase wrapping more than phase information at earlier echoes due to larger amounts of phase accumulation. This can degrade the performance of phase unwrapping algorithms that only consider the phase unwrapping problem at each echo time independently. ROMEO is able to constrain the unwrapping solution across all echoes by modeling the linear phase accumulation across echoes. This provides more accurate phase unwrapping solutions over other phase unwrapping methods, but requires the removal of phase offsets prior to unwrapping. \n\n\n#### Temporal phase correction \n  \nOnce the phases of all frames in a single ME-fMRI scan are unwrapped. A temporal correction step is applied to ensure phase unwrapping consistency across frames. For each frame, the phase of the first echo is considered against every other frame in an ME-fMRI scan that has a similar correlation with their corresponding magnitude image. Within a group of frames with a correlational similarity of 0.98 or greater, the phase values are corrected by adding/subtracting the nearest 2  \u03c0   multiple that minimizes the difference to the mean phase value of the group, given by:\n \nwhere   m   denotes the frame index of the EPI time series, \u230a\u2309 denotes the rounding operator, and   is the mean phase value for the grouped first echo frames similar to frame   m  . Temporal phase correction for subsequent echos is performed by linearly projecting the expected phase values beyond the previous echos:\n \nwhere   n   denotes the index of any echo after the first echo, and   t   is the echo time for the associated echo. \n\n\n#### Weighted field map computation \n  \nField map estimation is accomplished with a weighted linear regression model. Since signal decay increases with echo time, SNR at later echoes tends to be lower than at earlier echoes, especially in areas of high susceptibility. To reduce the influence of voxels with low signal on the field map estimation, we weight by the squared magnitude of the signal at each echo time. Solving for   then becomes a weighted least squares problem:\n \nwhere   W   is a diagonal weight matrix containing the magnitude of the signal at each echo time,   is the vector of phase values at each echo time for each voxel, and t is the vector of echo times.   is computed for each frame to yield a field map time series corresponding to each frame of the ME-fMRI time series. \n\n\n#### Low rank approximation \n  \nTo reduce the effects of temporal noise components in the field maps, we employ a low rank approximation approach. This step is vital for removing large field changes along the borders of the brain, which tend to contain spurious changes in the field map due to a lack of signal or high measurement noise. The low rank approximation problem can be formulated as follows:\n \nwhere   f   is the field map time series, reshaped as an   N   \u00d7  T   matrix (where   N   is the voxel dimension and   T   is the time dimension),   is the low rank approximation of   f  , and   n   is the rank of the approximation. The solution to   is given by the Eckart\u2013Young\u2013Mirsky theorem [ ], which is simply the   n  -truncated singular value decomposition of   f  :\n \nwhere   U   and   V   are the left and right singular vectors of   f  , respectively, and \u03a3  is the diagonal matrix of the first   n   singular values of   f  . For the solution estimated from   in our results, we used   n   = 10. \n\n\n#### Displacement Field Inversion \n  \nFinally, to obtain the final field map in the undistorted space, each frame of the field map time series is converted to a displacement field using the readout time and voxel size of the data. This displacement field is then inverted to the nearest diffeomorphic inverse to obtain the final field map in the undistorted space. Displacement field inversion was performed using the   InvertDisplacementFieldImageFilter   of the ITK library [ ]. \n\n\n\n### Data Acquisition \n  \n#### Head motion dataset \n  \nHead motion data was collected on a single adult participant to assess MEDIC\u2019s capability in measuring and correcting B0 field changes due to head movement. Participant was asked to rotate their head along each cardinal axis of the scanner, while 3 TOPUP spin-echo field maps (TR: 8 s, TE: 66 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0mm) pairs and magnitude/phase ME-fMRI data (TR: 1.761 s, TEs: 14.2, 38.93, 63.66, 88.39, 113.12 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0 mm, Multi-Band: 6, iPAT: 2) were collected using a 3T whole-body scanner (Prisma, Siemens Healthcare). For each rotated head position, ~3 minutes of ME-fMRI data was collected. To serve as a reference for highly precise resting-state functional connectivity data, ~150 minutes of additional ME-fMRI data was collected over 4 scanning sessions. For anatomical images, T1w (Multi-echo MPRAGE, TR: 2.5 s, TEs: 1.81, 3.6, 5.39, 7.18 ms, 208 Slices, FOV: 300\u00d7300, Voxel Size: 0.8 mm, Bandwidth: 745 Hz/px) and T2w (T2 SPACE, TR: 3.2, TE: 565 ms, 176 Slices, Turbo Factor: 190, FOV: 256\u00d7256, Voxel Size: 1 mm, Bandwidth: 240 Hz/px) were collected. \n\n\n#### Adolescent dataset \n  \nA dataset with 21 participants was acquired to assess MEDIC\u2019s distortion correction performance on a group level (ages: 9\u201312; 8M, 13F; 15 Control, 1 ASD, 6 ADHD). TOPUP spin-echo field maps (TR: 8 s, TE: 66 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0mm) and magnitude/phase ME-fMRI data (TR: 1.761 s, TEs: 14.2, 38.93, 63.66, 88.39, 113.12 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0 mm, Multi-Band: 6, iPAT: 2) was collected using a 3T whole-body scanner (Prisma, Siemens Healthcare). For each participant, three scans of ME-fMRI data were collected (2x ~16 minutes, 1x ~10 minutes) across 2\u20135 sessions. For anatomical images, T1w (MPRAGE, TR: 2.5 s, TEs: 2.9 ms, 176 Slices, FOV: 256\u00d7256, Voxel Size: 1.0 mm, Bandwidth: 240 Hz/px) and T2w (T2 SPACE, TR: 3.2, TE: 565 ms, 176 Slices, Turbo Factor: 200, FOV: 256\u00d7256, Voxel Size: 1 mm, Bandwidth: 4882 Hz/px) images were also collected. Real time motion monitoring was used during all acquisitions [ ]. \n\n\n#### UMinn dataset \n  \nA single adult participant (age: 25) with TOPUP spin-echo field maps (TR: 8 s, TE: 66 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0mm) and magnitude/phase ME-fMRI data (TR: 1.761 s, TEs: 14.2, 38.93, 63.66, 88.39, 113.12 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0 mm, Multi-Band: 6, iPAT: 2) was collected using a 3T whole-body scanner (Prisma, Siemens Healthcare). ME-fMRI data was collected over 4 sessions, with a total of ~174 minutes of resting-state data acquired. For anatomical images, T1w (MPRAGE, TR: 2.5 s, TEs: 2.9 ms, 176 Slices, FOV: 256\u00d7256, Voxel Size: 1.0 mm, Bandwidth: 240 Hz/px) and T2w (T2 SPACE, TR: 3.2, TE: 565 ms, 176 Slices, Turbo Factor: 190, FOV: 256\u00d7256, Voxel Size: 1 mm, Bandwidth: 240 Hz/px) were collected. \n\n\n#### Penn dataset \n  \nA single adult participant (age: 30) with TOPUP spin-echo field maps (TR: 8 s, TE: 66 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0mm) and magnitude/phase ME-fMRI data (TR: 1.761 s, TEs: 14.2, 38.93, 63.66, 88.39, 113.12 ms, 72 Slices, FOV: 110\u00d7110, Voxel Size: 2.0 mm, Multi-Band: 6, iPAT: 2) was collected using a 3T whole-body scanner (Prisma, Siemens Healthcare). Two ~6 minute scans of resting-stage ME-fMRI data was collected. For anatomical images only a T1w (MPRAGE, TR: 2.5 s, TEs: 2.9 ms, 176 Slices, FOV: 256\u00d7256, Voxel Size: 1.0 mm, Bandwidth: 240 Hz/px) image was collected. \n\n\n#### ABCD dataset \n  \nA large-scale group averaged resting-state functional connectivity map from the Adolescent Brain Cognitive Development (ABCD) study was used to compare individual functional connectivity to averaged group data. This group average map used strict denoising (N = 3,928; >8 min; RSFC data post frame censoring at a filtered framewise displacement <0.08 mm) to remove the effects of nuisance variables such as head motion and respiration [ ]. During ABCD data preprocessing, FSL TOPUP was used for distortion correction. More information on ABCD dataset processing can be found in [ ]. \n\n\n\n### Processing pipeline \n  \nWe compared MEDIC\u2019s dynamic distortion correction to the gold-standard of static distortion correction, FSL TOPUP [ ]. For all comparisons, a common pipeline was used where all processing steps were kept the same, with the exception of the distortion correction method. For the MEDIC pipeline, field maps were computed and corrected for each frame of the ME-fMRI data using MEDIC. For the TOPUP pipeline, field maps were processed using FSL TOPUP [ ], then coregistered to the ME-fMRI data using 4dfp tools [ ]. The same field map was then applied to each frame of the ME-fMRI for distortion correction. Note that for the low motion dataset, only TOPUP correction was used as a distortion correction method during preprocessing. \n\nBoth T1w and T2w anatomical data were processed by debiasing using FSL FAST [ ] before passing into Freesurfer for anatomical segmentation [ ]. Anatomical data was then aligned to the MNI152 atlas [ ,  ] using 4dfp tools [ ]. For ME-fMRI data, slice time correction and motion correction using 4dfp tools. Bias field correction of the ME-fMRI data was performed using N4 Bias field correction [ ]. Coregistration of the functional data to the anatomical data via the T2w image was performed using 4dfp tools [ ]. The final atlas aligned functional data was computed using a one step resampling of the concatenated transforms (motion correction, distortion correction, functional to anatomical coregistration, anatomical to atlas coregistration) using FSL applywarp [ ]. The ME-fMRI data was combined into an optimally weighted combined image prior to nuisance regression and mapping to the surface using Connectome Workbench [ ]. Frame censoring was applied to remove the effects of head motion using a FD threshold of 0.08 after filtering for respiration [ ]. \n\n\n\n## Supplementary Material \n  \n \n", "metadata": {"pmcid": 10705259, "text_md5": "c928c2d743b232f7c0f75483f46cc4a0", "field_positions": {"authors": [0, 698], "journal": [699, 706], "publication_year": [708, 712], "title": [723, 793], "keywords": [807, 845], "abstract": [858, 2157], "body": [2166, 44717]}, "batch": 1, "pmid": 38077010, "doi": "10.1101/2023.11.28.568744", "pmc_url": "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10705259", "efetch_url": "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&id=10705259"}, "display_title": "pmcid: <a href=\"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10705259\">10705259</a>", "list_title": "PMC10705259  Framewise multi-echo distortion correction for superior functional MRI"}
