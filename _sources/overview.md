---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.14.1
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---
# Biomedical literature annotations

This {{ "[repository]({})".format(repo_url) }} stores manual annotations (a.k.a tagging, labelling) of biomedical scientific publications.
Examples of information that has been annotated in some documents are the number of study participants, their mean age, or the imaging modality.
Such annotations have diverse uses such as studying the evolution of a scientific field's methods, evaluating automatic information extraction systems, or informing meta-analyses.

The documents found here are journal articles from {{ pmc_home }}, collected using {{ pubget_home }}.
The annotations are made with {{ labelbuddy_home }}, and data is stored in {{ lb }}'s format (JSON).

This page provides a brief overview of the repository's content, and the rest of the documentation illustrates how to use and contribute to the repository:

```{tableofcontents}
```

## Projects

The repository's contents are organized into *projects*, found in the {{ "[`projects/`]({}projects)".format(repo_tree_url) }} directory.
Here are the currently existing projects:

```{code-cell}
:tags: [remove-input]
import pandas as pd

from labelrepo import database

connection = database.get_database_connection()

df = pd.read_sql(
    """
    select * from 
    (select project_name, count(distinct doc_id) as documents,
    count(distinct label_id) as labels,
    count(distinct annotator_name) as annotators,
    count(*) as annotations from
    annotation group by project_name order by documents desc)
    union all 
    select 'Total' as project_name, count(distinct doc_id) as documents,
    count(distinct label_id) as labels,
    count(distinct annotator_name) as annotators,
    count(*) as annotations 
    from annotation;
""",
    connection,
)
link = (
    r'<a href="https://github.com/neurodatascience/labelbuddy-annotations/'
    r'tree/main/projects/\1">\1</a>'
)
df.iloc[:-1, 0] = df.iloc[:-1, 0].str.replace(r"(.*)", link, regex=True)
df.style.hide(axis="index")
```

Each project contains 3 directories: `labels/`, `documents/` and `annotations/`, corresponding to the 3 types of objects stored in this repository.

## Documents

Documents represent scientific journal articles; they contain the article's text and some metadata.
They are generated by invoking {{ pubget_home }} with the `--labelbuddy` option.
They are stored in {{ lb }}'s [JSONLines format](https://jeromedockes.github.io/labelbuddy/labelbuddy/current/documentation/#docs-jsonl-format).

Each document is represented by a JSON dictionary; the keys of interest are:
- **text:** the article's content as plain text as extracted by {{ pg }}.
- **metadata:** basic metadata, including the PubMed ID (**pmid**), PubMedCentral ID (**pmcid**), and **doi** when available.

Below is an example document. 
(Here the text is abbreviated and the JSON is displayed in a readable way, but in the actual JSONLines file the whole information for each document is on a single line.)

```{code-cell}
:tags: [remove-input, hide-output]
import json

from labelrepo import repo

docs_file = (
    repo.repo_root()
    / "projects"
    / "participant_demographics"
    / "documents"
    / "documents_00001.jsonl"
)
with open(docs_file, encoding="utf-8") as stream:
    doc = json.loads(next(stream))
doc["text"] = f"{doc['text'][:80]} [ … ]"
print(json.dumps(doc, indent=2, ensure_ascii=False))
```

```{code-cell}
:tags: [remove-cell]
import myst_nb

document_count = connection.execute(
    "select count(*) from document"
).fetchone()[0]
myst_nb.glue("document_count", document_count)

annotated_document_count = connection.execute(
    "select count(distinct doc_id) from annotation"
).fetchone()[0]
myst_nb.glue("annotated_document_count", annotated_document_count)
```
There are currently {glue:text}`document_count` documents in the repository, {glue:text}`annotated_document_count` of which are annotated (more details below).

## Labels

Labels are simple tags that can be attached to a portion of a document's text.
They can optionally have a `color` and a `shortcut_key`, used in {{ lb }} when we are annotating a document.

For example, here are the labels listed in the `cluster_inference` project:

```{code-cell}
:tags: [remove-input]
from labelrepo import displays, read_json

labels_file = (
    repo.repo_root()
    / "projects"
    / "cluster_inference"
    / "labels"
    / "labels_kendra.json"
)
labels = connection.execute(
"select * from label inner join project_label "
"on project_label.label_id = label.id "
"where project_label.project_name = 'cluster_inference'")
displays.LabelsDisplay(labels)
```
The labels are stored in {{ lb }}'s [JSON format](https://jeromedockes.github.io/labelbuddy/labelbuddy/current/documentation/#labels-json-format); below is an example.


```{code-cell}
:tags: [remove-input, hide-output]
print(labels_file.read_text("utf-8"))
```

```{code-cell}
:tags: [remove-cell]

label_count = connection.execute(
"select count(*) from label"
).fetchone()[0]
myst_nb.glue("label_count", label_count)
```

There are currently {glue:text}`label_count` labels in the repository.

## Annotations

Finally, an annotation is the association of a label to a portion of a document's text.
It thus consists of a label name and the character positions where it starts and ends.

Here are a few example annotations:

```{code-cell}
:tags: [remove-input]
from labelrepo import displays

displays.AnnotationsDisplay(
    connection.execute(
        "select * from detailed_annotation where "
        "label_name not glob '_*' and "
        "label_name not glob '*discard*' order by project_name limit 5;"
    ).fetchall()
)
```

```{code-cell}
:tags: [remove-cell]
annotation_count = connection.execute(
    "SELECT COUNT(*) AS annotation_count FROM annotation"
).fetchone()["annotation_count"]
myst_nb.glue("annotation_count", annotation_count)
```

Annotations are stored in {{ lb }}'s JSONL format, below is an example for one document.
(Here also, the annotations are layed out in a readable way but in the JSONL files the whole information for one document is on a single line.)

```{code-cell}
:tags: [remove-input, hide-output]
annotations_file = (
    repo.repo_root()
    / "projects"
    / "autism_mri"
    / "annotations"
    / "David_Kennedy.jsonl"
)
with open(annotations_file, encoding="utf-8") as stream:
    annotations = json.loads(next(stream))

annotations
```

In total there are {glue:text}`annotation_count` annotations in the repository.

## Number of labelled documents by project

Now, we display the number of documents annotated with each label in the different projects:

```{code-cell}
:tags: [remove-cell]

label_counts = pd.read_sql(
    """
      with annot as
      (select distinct label_id, doc_id, project_name from annotation)
    SELECT project_name, label.name AS label_name, label.color as color, COUNT(*) AS n_docs
    from
      annot
      INNER JOIN label ON annot.label_id = label.id
      INNER JOIN document ON annot.doc_id = document.id
      GROUP BY project_name, label_name
      ORDER BY n_docs DESC
    """,
    connection,
)

project_counts = pd.read_sql(
    """
    select project_name, count(*) as n_docs
      from (select distinct project_name, doc_id from annotation)
      group by project_name
    """,
    connection,
).set_index("project_name")["n_docs"]
```


```{code-cell}
:tags: [remove-input]
from matplotlib import pyplot as plt
import seaborn as sns

projects = label_counts.groupby("project_name", sort=False)

for project_name, data in projects:
    fig, ax = plt.subplots(figsize=(4, data.shape[0] / 3))
    sns.barplot(
        data=data, x="n_docs", y="label_name", ax=ax, color="#0071BC", alpha=.8
    )
    ax.yaxis.set_tick_params(left=False)
    ax.set_title(
        f'“{project_name}” project ({project_counts[project_name]} annotated documents)'
    )
    ax.set_ylabel("")
    ax.set_xlabel("Number of documents annotated with this label")
    sns.despine()
```
